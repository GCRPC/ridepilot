<%= form_for(@trip) do |f| %>
  <% if @trip.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@trip.errors.count, "error") %> prohibited this trip from being saved:</h2>

      <ul>
      <% @trip.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <!-- the customer id needs to be passed in this action -->
  <%= f.hidden_field :customer_id, :value=>@customer.id %>

  <fieldset class="new-trip">

    <ol class="section first">
      <li class="selfclear">
        <label for="customer">Customer:</label>
        <strong><%= @customer.name %></strong>
      </li>

      <li class="selfclear time">
        <%= f.label :pickup_time, "Pickup Time:" %>
        <%= f.text_field :pickup_time %>
      </li>

      <li class="selfclear time">
        <%= f.label :appointment_time, "Appointment Time:" %>
        <%= f.text_field :appointment_time %>
      </li>

      <li class="selfclear">
        <!-- we need some complexity, because this form handles 
             both trips and repeating trips.
             So, we'll just put all the repeating stuff into
             plain params and handle it in the controller
          -->
        <label for="repeats_id">Repeats:</label>
        <ul>
          <li>
            <input type="checkbox" name="monday" value="Monday" <%= @schedule.monday ? 'checked="checked"' : '' %>/> M&nbsp;
            <input type="checkbox" name="tuesday" value="Tuesday" <%= @schedule.tuesday ? 'checked="checked"' : '' %>/> T&nbsp;
            <input type="checkbox" name="wednesday" value="Wednesday" <%= @schedule.wednesday ? 'checked="checked"' : '' %>/> W&nbsp;
            <input type="checkbox" name="thursday" value="Thursday" <%= @schedule.thursday ? 'checked="checked"' : '' %>/> R&nbsp;
            <input type="checkbox" name="friday" value="Friday" <%= @schedule.friday ? 'checked="checked"' : '' %>/> F&nbsp;
          </li>
          <li>
            every <input type="text" size="2" name="interval" id="interval" value="<%= @schedule.interval %>"/> week(s)
          </li>
        </ul>
      </li>

      <li class="selfclear">
        <%= f.label :pickup_address_label, "Pickup Address:" %>
        <%= text_field_tag "pickup_address_label", @trip.pickup_address ? @trip.pickup_address.text : '', :class => "full" %>
        <%= f.hidden_field(:pickup_address_id) %>
      </li>

      <li class="selfclear">
        <%= f.label :dropoff_address_label, "Dropoff Address:" %>
        <%= text_field_tag "dropoff_address_label", @trip.dropoff_address ? @trip.dropoff_address.text : '', :class => "full" %>
        <%= f.hidden_field(:dropoff_address_id) %>
      </li>

      <li class="selfclear">
        <label for="phone">Phone:</label>
        <input type="text" size="14" name="phone" id="phone" value="<%= @customer.phone_number_1 %>" readonly="readonly"/>
      </li>

      <li class="selfclear">
        <label for="alt_phone">Alt. Phone:</label>
        <input type="text" size="14" name="alt_phone" id="alt_phone" value="<%= @customer.phone_number_2 %>" readonly="readonly"/>

      </li>
    </ol>
    
    <ol class="section second">
      <li class="selfclear">
        <%= f.label :trip_purpose, "Trip Purpose:" %>
        <%= f.select :trip_purpose, @trip_purposes %>
      </li>

      <li class="selfclear passengers">
        <%= f.label :guest_count, "Passengers:" %>
        <ul>
          <li>
            <span class="nobreak"><%= f.text_field :guest_count %>&nbsp;Guests&nbsp;</span>
            <span class="nobreak"><%= f.text_field :attendant_count %>&nbsp;Attendants</span>
          </li>
          <li>
            <input type="checkbox" name="group" value="Group" /> Group
          </li>
        </ul>
      </li>

      <li class="selfclear">
        <%= f.label :vehicle_id, "Vehicle:" %>
        <%= f.collection_select :vehicle_id, @vehicles, :id, :name %><br/>
      </li>

      <li class="selfclear">
        <label for="customer_private_notes">Customer Private Notes:</label>
        <textarea rows="20" name="customer_private_notes" id="customer_private_notes" cols="40" readonly="readonly"><%= @customer.private_notes %></textarea>
      </li>
    </ol>

    <ol class="section third">
      <li class="selfclear">
        <%= f.label :trip_result, "Result:" %>
        <%= f.select :trip_result, @trip_results %>
      </li>

      <li class="selfclear donation">
        <%= f.label :donation, "Donation:" %>
        <%= f.text_field :donation %>
      </li>

      <li class="selfclear">
        <%= f.label :funding_source_id, "Funding Source:" %>
        <%= f.collection_select :funding_source_id, @funding_sources, :id, :name %>
      </li>

      <li class="selfclear">
        <%= f.label :mobility_id, "Mobility Req.:" %>
        <%= f.collection_select :mobility_id, @mobilities, :id, :name %>
      </li>

      <li class="selfclear">
        <label for="mobility_notes">Mobility Notes:</label>
        <textarea rows="20" name="mobility_notes" id="mobility_notes" cols="40" readonly="readonly"><%= @customer.mobility_notes %></textarea>
      </li>
    </ol>

    <ol class="section fourth double">
      <li class="selfclear">
        <%= f.label :notes, "Trip Notes:" %>
        <%= f.text_area :notes %>
      </li>
      <li class="selfclear">
        <%= f.label :customer_informed, "Called Back:" %>
        <%= f.check_box :customer_informed %>
        <% if @trip.customer_informed %>
          on <%= @trip.called_back_at %>
          by  <%= @trip.called_back_by.email %>
        <% end %>
      </li>
    </ol>

    <div class="actions">
      <%= f.submit %>
    </div>

  </fieldset>

<% end %>


        <div id="pickup-address-form" class="address-form">
          <%= render :partial=>'find_or_create_address', :locals=>{:prefix=>'pickup'} %>
        </div>


        <div id="dropoff-address-form" class="address-form">
          <%= render :partial=>'find_or_create_address', :locals=>{:prefix=>'dropoff'} %>
        </div>



<script type='text/javascript'>

  function pickup_autocompleted(address) {
    autocompleted(address, 'pickup');
  }
  function dropoff_autocompleted(address) {
    autocompleted(address, 'dropoff');
  }
  function autocompleted(address, field) {
      if (address.id) {
        //found an existing address
        id_field = '#trip_' + field + '_address_id';
        $(id_field).val(address.id);
        label_field = '#' + field + '_address_label';
        $(label_field).val(address.label);
        //close dialog
        $( "#" + field + "-address-form" ).dialog( "close" );
      } else {
        //found a geocode, fill in fields
        $('#' + field + '_name').val(address.name);
        $('#' + field + '_building_name').val(address.building_name);
        $('#' + field + '_address').val(address.address);
        $('#' + field + '_city').val(address.city);
        $('#' + field + '_state').val(address.state);
        $('#' + field + '_zip').val(address.zip);
        $('#' + field + '_lat').val(address.lat);
        $('#' + field + '_lon').val(address.lon);
        $('#' + field + '_in_district').val(address.in_district);
      }
    }
    
    $('.address-search').bind('ajax:success', function(evt, data, status, xhr){
      if (data.id) {
        //successfully created a new address
        id_field_id = $(this).attr('data-id-element');
        $(id_field_id).val(data.id);
        label_field_id = $(this).attr('data-label-element');
        $(label_field_id).val(data.label);
        //close dialog
        $($(this)[0].parentNode).dialog( "close" );
      } else {
        //failed to create an address

        for (var field in data) {
          text_field = $('#' + data.prefix + "_" + field);
          error_element = text_field.attr('data-error-element');
          if (!error_element) {
            error_element_id = data.prefix + "_" + field
            text_field.after('<span class="error" id="' + error_element_id + '">' + data[field] + "</span>");
            error_element = "#" + error_element_id;
            text_field.attr('data-error-element', error_element);
          }
          $(error_element).innerHtml = data[field]
        }
      }
    });


    $(document).ready(function() {


        var year = new Date().getFullYear();
        var month = new Date().getMonth();
        var day = new Date().getDate();

        $('#calendar').weekCalendar({
            timeslotsPerHour: 4,
            daysToShow: 5,
            firstDayOfWeek: 1,
            businessHours: {start: 0, end: 24, limitDisplay: true},
            headerSeparator: ", ",
            height: function($calendar){
                return 250;
            },
            eventRender : function(calEvent, $event) {
                if(calEvent.end.getTime() < new Date().getTime()) {
                    $event.css({ opacity: 0.33 });
                }
            },
            data:'<%= trips_path :json %>'
        });


/* 
 * stubbing in address dialog functionality
 * cargo-cult'd via http://jqueryui.com/demos/dialog/#modal-form 
 */
        $(function() {
            var address = $( "#address" ),
                tips = $( ".validateTips" );
    
            function updateTips( t ) {
                tips
                    .text( t )
                    .addClass( "ui-state-highlight" );
                setTimeout(function() {
                    tips.removeClass( "ui-state-highlight", 1500 );
                }, 500 );
            }
    
            function checkLength( o, n, min, max ) {
                if ( o.val().length > max || o.val().length < min ) {
                    o.addClass( "ui-state-error" );
                    updateTips( "Length of " + n + " must be between " +
                        min + " and " + max + "." );
                    return false;
                } else {
                    return true;
                }
            }
    
            function checkRegexp( o, regexp, n ) {
                if ( !( regexp.test( o.val() ) ) ) {
                    o.addClass( "ui-state-error" );
                    updateTips( n );
                    return false;
                } else {
                    return true;
                }
            }
            
            $( ".address-form" ).dialog({
                autoOpen: false,
                height: 330,
                width: 600,
                modal: true,
                buttons: {
                    "Add Address": function() {
                        form = $( this )[0].children[0];
                        $(form).trigger('submit'); 
                    },
                    Cancel: function() {
                        $( this ).dialog( "close" );
                    }
                },
                close: function() {
                }
            });
    
            $( "#pickup_address_label" ).click(function() {
                $( "#pickup-address-form" ).dialog( "open" );
            });
            $( "#dropoff_address_label" ).click(function() {
                $( "#dropoff-address-form" ).dialog( "open" );
            });
        });

    });

</script>
