<script type='text/javascript'>

  function autocompleted(address, field) {
    if (address.label == "New Address") {
      $( "#" + field + "-address-form" ).dialog( "open" );
    } else if (address.id) {
      //found an existing address
        id_field = '#trip_' + field + '_address_id';
      $(id_field).val(address.id);
      label_field = '#' + field + '_address_label';
      $(label_field).val(address.label);
      //close dialog
      $( "#" + field + "-address-form" ).dialog( "close" );
    } else {
      //found a geocode, fill in fields, open the dialog for saving
      $('#' + field + '_name').val(address.name);
      $('#' + field + '_building_name').val(address.building_name);
      $('#' + field + '_address').val(address.address);
      $('#' + field + '_city').val(address.city);
      $('#' + field + '_state').val(address.state);
      $('#' + field + '_zip').val(address.zip);
      $('#' + field + '_lat').val(address.lat);
      $('#' + field + '_lon').val(address.lon);
      $('#' + field + '_in_district').val(address.in_district);
      $( "#" + field + "-address-form" ).dialog( "open" );
    }
  }

  $(document).ready(function() {
    
    // happens after you submit an address (not autocomplete)
    // an id should be returned, and then the form should close.
    // if no id is returned, error messages are filled in. 
    $('.address-search').bind('ajax:success', function(evt, data, status, xhr){
      if (data.id) {
        //successfully created a new address
        id_field_id = $(this).attr('data-id-element');
        $(id_field_id).val(data.id);
        label_field_id = $(this).attr('data-label-element');
        $(label_field_id).val(data.label);
        //close dialog
        $($(this)[0].parentNode).dialog( "close" );
      } else {
        //failed to create an address

        for (var field in data) {
          text_field = $('#' + data.prefix + "_" + field);
          error_element = text_field.attr('data-error-element');
          if (!error_element) {
            error_element_id = data.prefix + "_" + field
            text_field.after('<span class="error" id="' + error_element_id + '">' + data[field] + "</span>");
            error_element = "#" + error_element_id;
            text_field.attr('data-error-element', error_element);
          }
          $(error_element).innerHtml = data[field]
        }
      }
    });

    $('#calendar').weekCalendar({
        timeslotsPerHour: 4,
        daysToShow: 5,
        firstDayOfWeek: 1,
        businessHours: {start: 8, end: 18, limitDisplay: true},
        allowCalEventOverlap: true,
        overlapEventsSeparate: true,
        headerSeparator: ", ",
        timeslotHeight: 15,
        height: function($calendar){
              calHeight = $(window).height() * 0.3 + 40;
              return calHeight;
        },
        textSize: 10,
        defaultEventLength: 3,
        readonly: true,
        eventRender : function(calEvent, $event) {
            if(calEvent.end.getTime() < new Date().getTime()) {
                $event.css({ opacity: 0.33 });
            }
        },
        eventClick: function(calEvent, element) {
          window.location = "<%= edit_trip_path 'CHANGE_ME' %>".replace(/CHANGE_ME/, calEvent['id']);
        },
        data: function(start, end, callback){
          $.getJSON('<%= trips_path :json %>',
            { start:start.getTime()/1000, end:end.getTime()/1000 },
            function(data, textStatus, jqXHR){
              callback(data.events);

              var table = $("#calendar").next("table");
              table.find("tr.trip").remove();
              $.each(data.rows, function(i, row){
                table.append(row);
              })
            }
          );
        }
    });

    <% if @trip.present? && @trip.pickup_time.present? %>
      $("#calendar").weekCalendar("gotoWeek", ISODateFormatToDateObject($("#trip_pickup_time").val()));
    <% end %>

    // address dialog functionality
    // via http://jqueryui.com/demos/dialog/#modal-form 
    $( ".address-form" ).dialog({
        autoOpen: false,
        height: 395,
        width: 600,
        modal: true,
        buttons: {
            "Add Address": function() {
                form = $( this )[0].children[0];
                $(form).trigger('submit'); 
            },
            Cancel: function() {
                $( this ).dialog( "close" );
            }
        },
        close: function() {
        }
    });
    
    $('#trip_pickup_time, #trip_appointment_time').datetimepicker({
    	ampm: false,
    	hourMin: 8,
    	hourMax: 18,
  		hourGrid: 3,
    	minuteGrid: 15,
  		timeFormat: 'hh:mm',
  		dateFormat: 'yy-mm-dd',
      showOn: "button",
      buttonImage: "<%=  image_path 'calendar-clock.png' %>",
      buttonImageOnly: true,
      constrainInput: false
    });

    $('#pickup_search_address').bind('railsAutocomplete.select', function(e, selected){
      autocompleted(selected, 'pickup');
    });
    
    $('#dropoff_search_address').bind('railsAutocomplete.select', function(e, selected){
      autocompleted(selected, 'dropoff');
    });
    
  });

</script>
